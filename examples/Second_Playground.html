<html>

<head>
  <meta charset="utf-8">
  <title>Positional Audio Example — Networked-Aframe</title>
  <meta name="description"
    content="Dev Example — Networked-Aframe">

  

  <!-- Aframe -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.5.0/socket.io.slim.js"></script>
  <script src="/easyrtc/easyrtc.js"></script>
  <script src="https://unpkg.com/networked-aframe@^0.11.0/dist/networked-aframe.min.js"></script>

  <!-- Essentia -->
  <script src="https://unpkg.com/essentia.js@0.0.9-dev/dist/essentia-wasm.web.js"></script>
  <script src="https://unpkg.com/essentia.js@0.0.9-dev/dist/essentia.js-core.js"></script>
  <script src="https://unpkg.com/essentia.js@0.0.9-dev/dist/essentia.js-plot.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <!-- Tonejs -->
  <script src="https://unpkg.com/tone@~14.7.77"></script> <!--https://unpkg.com/tone-->

  <!-- Miei -->
  <script src="js/voxel-spawn.js"></script>
  <script src="js/random-color.js"></script>
  <script src="js/spawn-in-circle.component.js"></script>
  <script src="js/audio-worklet.js"></script> <!--Tone js stuff-->
  <script src="js/essentia-components.js"></script> <!--volume bars, waveforms, mouth, hair...-->
  <!--<script src="js/managerMessage.js"></script>-->

  <!-- Extras - NAF options -->
  <script>NAF.options.updateRate = 90; //default 15, around 10-20 for multiusers... 1000ms /30 = 33.3</script> 
  <!-- Lerp -->
  <script> NAF.options.useLerp = true; </script>

  <!--XXXXXXXXXXXXXXXXXXX-->
  <!--    used for flying in this demo  -->
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script> 
  <script>
      // Hypnos-phi/aframe-extras@37fd255 is https://github.com/n5ro/aframe-extras/pull/373
      // Also waiting https://github.com/n5ro/aframe-extras/pull/377 to be merged
      // Redefine the alias for now:
      THREE.Math = THREE.MathUtils;
    </script>
  <script src="https://cdn.jsdelivr.net/gh/Hypnos-phi/aframe-extras@37fd255/dist/aframe-extras.controls.min.js"></script>

  <link rel="stylesheet"
    type="text/css"
    href="/css/style.css" />
</head>

<body class="container">
  <a-scene persistent-p2p networked-scene="
      room: persistent-peer-to-peer; 
      debug: true;
      adapter: easyrtc;
      audio: true;
    ">
    <a-assets>

      <img id="groundTexture"
        src="https://cdn.aframe.io/a-painter/images/floor.jpg"
        crossorigin="anonymous" />
      <img id="skyTexture"
        src="https://cdn.aframe.io/a-painter/images/sky.jpg"
        crossorigin="anonymous" />

        
      <img id="score-image" src="./assets/score.jpg">
     

      <!-- XXXXXXXXXXXXXX  -->
        <a-asset-item id="left-hand-model" src="./assets/leftHandHigh.glb"></a-asset-item>
        <a-asset-item id="right-hand-model" src="./assets/rightHandHigh.glb"></a-asset-item>
      
        <!-- WORK XXXXXXXXXXXXXX  -->
      
      <!-- Camera Rig / Player -->
       <template id="camera-rig-template">
        <a-entity></a-entity>
      </template>
      
      <!--XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX-->

        <!-- Hands -->
        <template id="left-hand-template">
          <a-entity>
             <a-gltf-model class="tracked-left-hand" rotation="0 0 90" src="#left-hand-model"></a-gltf-model>
          </a-entity>
         </template>

         <template id="right-hand-template">
          <a-entity>
             <a-gltf-model class="tracked-right-hand" rotation="0 0 -90" src="#right-hand-model"></a-gltf-model>
          </a-entity>
         </template>

               <!--XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX-->

         <template id="left-hand-template" networked="template:#left-hand-template">
          <!--<a-entity networked-hand-controls="hand:left;handModelStyle:controller;"networked="template:#left-hand-default-template"></a-entity>-->
         <!-- tracked hand Left-->
         <a-entity>
         <a-gltf-model class="tracked-left-hand" rotation="0 0 90" position="0 0 0" src="#left-hand-model"></a-gltf-model>
         </a-entity> 



        
         <!-- oculus controllers -->
        </template>

     <!-- <a-gltf-model class="tracked-right-hand" rotation="0 0 -90" src="#right-hand-model"></a-gltf-model> -->
     <!--<a-entity
         networked-hand-controls="hand:right;handModelStyle:controller;"
        networked="template:#right-hand-default-template">
         </a-entity>-->
     <template id="right-hand-template" networked="template:#right-hand-template" >
          <!--<a-entity networked="template:#right-hand-template">-->
           <!--<a-entity networked-hand-controls="hand:right;handModelStyle:controller;"networked="template:#right-hand-default-template">-->
        <!-- tracked hand right-->
         <a-entity>
             <a-gltf-model class="tracked-right-hand" rotation="0 0 -90" position="0 0 0" src="#right-hand-model"></a-gltf-model>
         </a-entity>
     </template>


      <!-- Templates -->

      <!--XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX-->
      <!-- tracked-vr-hands-->
      

      <!-- Avatar -->
      <template id="avatar-template">
        <a-entity class="avatar"
          networked-audio-source>
          <a-sphere class="head"
                    scale="0.3 0.3 0.3" random-color></a-sphere>
          <a-entity class="face"
                    position="0 0.05 0">
            <a-sphere class="eye"
                      color="#efefef"
                      position="0.1 0.1 -0.15"
                      scale="0.12 0.12 0.12">
              <a-sphere class="pupil"
                        color="#000"
                        position="0 0.5 -0.8"
                        scale="0.2 0.2 0.2"></a-sphere>
            </a-sphere>
            <a-sphere class="eye"
                      color="#efefef"
                      position="-0.1 0.1 -0.15"
                      scale="0.12 0.12 0.12">
              <a-sphere class="pupil"
                        color="#000"
                        position="0 0.5 -0.8"
                        scale="0.2 0.2 0.2"></a-sphere>
            </a-sphere>
          </a-entity>
      </template>

      <!--Mouth-->
      <template id="mouth-template">
        <a-entity class="mouth">

          <!--<a-circle class="bocca" color="#CCC" radius="1"></a-circle>-->

          <a-box class="labbroSup"
            material="shader: standard"
            scale="0.2 0.05 0.1"></a-box>
          <a-box class="labbroInf"
            material="shader: standard"
            scale="0.2 0.05 0.1"></a-box>
        </a-entity>
      </template>


      <!--Block-->
      <template id="voxel">
        <a-entity class="box"
          geometry="primitive: box; height: 0.5; width: 0.5; depth: 0.5"
          material="shader: standard"
          random-color
          bar-volume-diff></a-entity>
      </template>

      <!--Hair-->
      <template id="hair-template">
        <a-entity class="hair"
          geometry="primitive: box"
          material="shader: standard"
          random-color></a-entity>
      </template>

      <!-- /Templates -->
    </a-assets>

    <!-- Ambiente -->
    <a-cylinder id="ground"
      src="#groundTexture"
      radius="52"
      height="0.1"></a-cylinder>

    <a-sky src="#skyTexture"
      theta-length="90"
      radius="50"></a-sky>

    <a-entity light="color: #ffffff; intensity: 1.5; type: ambient;"
      visible=""></a-entity>
    <a-entity light="color: #ffffff; intensity: 0.5"
      position="5 5 5"></a-entity>
    <!-- /Ambiente -->

    <!--Avatar mio-->
    <!-- XXXXXXXXXXXXXXXXXXXXXXX  -->
    

    <!--<a-entity id="player"
      networked="template:#avatar-template;attachTemplateToLocal:false;"
      camera
      position="0 1.6 0"
      spawn-in-circle="radius:3"
      wasd-controls
      look-controls
      hairs="num:50">-->

      <!-- 
      <a-entity id="player"
      networked="template:#avatar-template;attachTemplateToLocal:false;"
      movement-controls="speed:0.3;" 
      tracked-vr-hands
      spawn-in-circle="radius:3" 
      > -->
    
    <!-- XXXXXXXXXXXXXXXXXXXXXXX  -->
    <!--work-->
    
    <a-entity 
        id="player1" 
        movement-controls="speed:0.3;" 
        tracked-vr-hands
        spawn-in-circle="radius:3" 
        networked="template:#camera-rig-template;attachTemplateToLocal:false;"     
      >
    <!-- camera-rig-template -->
      
<!---
      <a-entity camera look-controls>
        <a-text value="Chord:"
        scale=".2 .2 1"
        position="0 .7 -1"
        color="black"
        chord></a-text>
      <a-text value="RMS:"
        scale=".2 .2 1"
        position="0 .6 -1"
        color="black"
        rms></a-text>
      <a-plane color="#CCC"
        scale=".5 .3 .1"
        position="-0 .7 -1.1">
      </a-plane>
    </a-entity>-->

    <a-entity id="player" 
            networked="template: #avatar-template; attachTemplateToLocal: false;" 
            camera position="0 1.6 0" 
            position-listener

            > <!--spawn-in-circle="radius:3" movement-controls="fly:true;" wasd-controls look-controls position-listener
                tracked-vr-hands --> <!--click-->
            <a-cursor color="yellow" intersection-spawn="event: click; template: #voxel"></a-cursor>

            <a-sphere class="head"
                visible="false"
                random-color></a-sphere>
      <a-entity networked="template:#mouth-template;attachTemplateToLocal:false;">
        <!--<a-circle class="bocca" color="#CCC" radius="1" labbro="type:bocc"></a-circle>-->
        <a-box class="labbroSup"
               position="0 -0.1 -0.35"
               visible="false"
               labbro="type:sup"></a-box>
        <a-box class="labbroInf"
               position="0 -0.22 -0.35"
               visible="false"
               labbro="type:inf"></a-box>

            <a-entity id="huddisplay">
              <a-plane color="#00FFFFFF"
              scale="1. 1. 1"
              position="1 -0.7 0">
            <a-text value="Chord:"
                scale=".2 .2 1"
                position="-1.15 .48 -1"
                color="black"
                chord>
            </a-text>
            <a-text value="RMS: "
                scale=".2 .2 1"
                position="-1.15 .39 -1"
                color="black"
                rms>
            </a-text>
            <a-plane color="#616161"
                scale=".5 .3 .1"
                position="-1 .4 -1.1">
            </a-plane>
          </a-plane>
          </a-entity>
            
          </a-entity>


        </a-entity>
       
        
       <!--XXXXXXXXXXXXXXXXXX-->
      <!--<a-cursor intersection-spawn="template:#voxel; event: click"
        fuse="false"></a-cursor>-->

      <!--HUD-->
      <!-- XXXXXXXXXXXX-->
      <!--
      <a-text value="Chord:"
        scale=".2 .2 1"
        position="-1.2 .7 -1"
        color="black"
        chord></a-text>
      <a-text value="RMS:"
        scale=".2 .2 1"
        position="-1.2 .6 -1"
        color="black"
        rms></a-text>
      <a-plane color="#CCC"
        scale=".5 .3 .1"
        position="-1.1 .7 -1.1"></a-plane>
      -->

      <a-box class="head"
        visible="false"
        random-color></a-box>

      <!--Mouth-->
      <a-entity networked="template:#mouth-template;attachTemplateToLocal:false;">
        
        <a-box class="labbroSup"
          position="0 -0.1 0.15"
          visible="false"
          labbro="type:sup"></a-box>
          <!--<a-circle class="bocca" color="#CCC" radius="1" labbro="type:bocc"></a-circle>-->
        <a-box class="labbroInf"
          position="0 -0.22 0.15"
          visible="false"
          labbro="type:inf"></a-box>
      </a-entity>

      </a-entity>
    </a-entity>

    <a-entity id="bars"
      bars-waveform="num: 128"> </a-entity> <!--256-->

    <!--<a-text value="Chord:"
      negate="false"
      scale="2 2 1"
      position="-2 2 -10"
      material=""
      chord></a-text>-->

  </a-scene>

  <script>

    // <!-- XXXXXXXXXXX -->
     // always register components before your scene
     AFRAME.registerComponent('tracked-vr-hands', {
        onEnterVR() {
          if (AFRAME.utils.device.isMobile()) return; // exclude e.g. cardboard, which lacks tracked controllers
          if (document.getElementById('my-tracked-right-hand')) return; // don't add them in more than once!
          // add these with JS:
          // <a-entity hand-controls="hand:left" networked="template:#left-hand-template;attachTemplateToLocal:true;"></a-entity>
          // <a-entity hand-controls="hand:right" networked="template:#right-hand-template;attachTemplateToLocal:true;"></a-entity>
          ['left', 'right'].forEach((side) => {
            const el = document.createElement('a-entity');
            el.setAttribute('hand-controls', { hand: side });
            el.setAttribute('networked', { template: `#${side}-hand-template`, attachTemplateToLocal: false });
            el.setAttribute('id', `my-tracked-${side}-hand`);
            // note that the ID will be applied to THIS client's hands,
            // but not other connected clients,
            // and not on the machine of other connected clients
            this.el.appendChild(el);
          });
        },
        init() {
          this.el.sceneEl.addEventListener('enter-vr', this.onEnterVR.bind(this));
          // future improvements:
          // pick up hand-controls events
          // https://github.com/aframevr/aframe/blob/b164623dfa0d2548158f4b7da06157497cd4ea29/docs/components/hand-controls.md
          // and broadcast the matching gestures to other connected clients
          // possibly trigger the animation on the model itself using animation-mixer:
          // https://github.com/n5ro/aframe-extras/tree/master/src/loaders
          // could add as 'networked-hands' component within repo
        }
      });

      

    // Define custom schema for syncing avatar color, set by random-color
    NAF.schemas.add({
      template: '#avatar-template',
      components: [
        'position',
        'rotation',
        {
          selector: '.head',
          component: 'material',
          property: 'color'
        },
      ]
    });

    NAF.schemas.add({
      template: '#mouth-template',
      components: [
        'position',
        'rotation',
        
        {
          selector: '.labbroSup',
          component: 'position',
        },
        {
          selector: '.labbroInf',
          component: 'position',
        }
        
      ]
    });

    //da usare con bar-volume-diff
    NAF.schemas.add({
      template: '#voxel',
      components: [
        'position',
        'rotation',
        'scale',
        {
          selector: '.box',
          component: 'scale',
        },
      ]
    });

    NAF.schemas.add({
      template: '#hair-template',
      components: [
        'position',
        'rotation',
        'scale',
        {
          selector: '.hair',
          components: ['position', 'scale']
        },
      ]
    });
  </script>

  <!-- HUD -->
  <div class="actions">
    <button id="mic-btn"
      type="button"
      class="button">Unmute Mic</button>
  </div>

</body>

</html>
